<div id="comments-section">
    <h3>Комментарии</h3>
    
    <form id="comment-form">
        <input type="hidden" id="news-id" value="{{ page.id }}">
        <div>
            <label for="author">Имя:</label>
            <input type="text" id="author" required>
        </div>
        <div>
            <label for="comment">Комментарий:</label>
            <textarea id="comment" required></textarea>
        </div>
        <button type="submit">Отправить на модерацию</button>
    </form>

    <div id="comments-list">
        <!-- Комментарии будут загружены здесь -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newsId = '{{ page.id }}';
    loadComments(newsId);
    
    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const commentData = {
            newsId: newsId,
            author: document.getElementById('author').value,
            text: document.getElementById('comment').value,
            timestamp: new Date().toISOString(),
            status: 'pending'
        };
        
        submitComment(commentData);
    });
});

function loadComments(newsId) {
    fetch(`/data/comments/${newsId}.json`)
    .then(response => {
        if (response.status === 404) {
            // Файла нет - это нормально для первой загрузки
            return [];
        }
        if (!response.ok) {
            throw new Error('Ошибка загрузки комментариев');
        }
        return response.json();
    })
    .then(comments => {
        const container = document.getElementById('comments-list');
        container.innerHTML = '';
        
        // Фильтруем только одобренные комментарии
        const approvedComments = comments.filter(c => c.status === 'approved');
        
        if (approvedComments.length === 0) {
            container.innerHTML = '<p>Пока нет комментариев. Будьте первым!</p>';
            return;
        }
        
        approvedComments.forEach(comment => {
            const commentEl = document.createElement('div');
            commentEl.className = 'comment';
            commentEl.innerHTML = `
                <strong>${comment.author}</strong>
                <small>${new Date(comment.timestamp).toLocaleString()}</small>
                <p>${comment.text}</p>
            `;
            container.appendChild(commentEl);
        });
    })
    .catch(error => {
        console.error('Error loading comments:', error);
        document.getElementById('comments-list').innerHTML = 
            '<p>Пока нет комментариев. Будьте первым!</p>';
    });
}

async function submitComment(comment) {
    const submitBtn = document.querySelector('#comment-form button');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';
        
        const response = await fetch('https://seoparse.netlify.app/.netlify/functions/handle-comment', {
            method: 'POST',
            mode: 'cors',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                newsId: comment.newsId,
                author: comment.author.substring(0, 50),
                text: comment.text.substring(0, 1000)
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || errorData.message || 'Ошибка сервера');
        }
        
        const data = await response.json();
        alert('Комментарий отправлен на модерацию!');
        document.getElementById('comment-form').reset();
        
    } catch (error) {
        console.error('Submit error:', error);
        alert('Ошибка: ' + (error.message || 'Попробуйте позже'));
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}
</script>

<style>
#comments-section {
    margin: 2rem 0;
    padding: 1rem;
    border-top: 1px solid #eee;
}

.comment {
    margin: 1rem 0;
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 4px;
}

.comment small {
    color: #666;
    display: block;
    margin: 0.3rem 0;
}

#comment-form div {
    margin: 1rem 0;
}

#comment-form label {
    display: block;
    margin-bottom: 0.3rem;
}

#comment-form input, #comment-form textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#comment-form textarea {
    min-height: 100px;
}

#comment-form button {
    background: #007acc;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#comment-form button:hover {
    background: #0062a3;
}
</style>